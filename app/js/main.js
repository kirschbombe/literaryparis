define("collections/articles",["jquery","underscore","backbone"],function(i,n,e){"use strict";var t=e.Collection.extend({model:"Article",app:null,init:null,initialize:function(i,n){var e=this;e.app=n.app,e.init=n.init,e.on("complete",function(){e.init.resolve(e)})}});return t});
define("collections/markers",["jquery","underscore","backbone"],function(n,e,i){"use strict";var t=i.Collection.extend({model:"Marker",app:null,init:null,initialize:function(n,e){var i=this;i.app=e.app,i.init=e.init,i.on("complete",function(){i.init.resolve(i)})}});return t});
define("mixins/after",["jquery"],function(e){"use strict";var r={after:function(r){var t=e.Deferred();return this.get(r)?t.resolve():this.on(r,function(){t.resolve()}),t}};return r});
define("mixins/domwatcher",["jquery"],function(e){"use strict";var t={watchDOM:function(t,o,n){if(!o)throw"Empty selector in watchDOM()";if(0===e(o).length){var d=function(){e(o).length>0&&(e(document.body).off("DOMNodeInserted",d),n.resolve())};e(document.body).on("DOMNodeInserted",d),window.setTimeout(function(){e(document.body).off("DOMNodeInserted",d),n.reject()},t)}else n.resolve()}};return t});
define("mixins/fetchxml",["jquery"],function(t){"use strict";var e={fetchXML:function(e,n){var r=t.ajax({type:"GET",url:n,dataType:"xml",success:function(t){return t},fail:function(t,e,r){console.log('Failed to fetch XML at url "'+n+'": '+r)}});return r}};return e});
define("mixins/xml2html",["jquery","underscore"],function(e,t){"use strict";var r={xml2html:function(e,r,n,o){var c;if("string"==typeof r)c=(new DOMParser).parseFromString(r,"text/xml");else{if("object"!=typeof r)throw console.log("Unrecognized doc"),"unrecognized doc";c=r}var i=new XSLTProcessor;i.importStylesheet(c),"object"==typeof n&&t.each(t.keys(n),function(e){i.setParameter(null,e,n[e])});var s;try{var a=i.transformToDocument(e);s=-1!=navigator.userAgent.indexOf("Firefox")?a.documentElement:a.body}catch(u){return""}return"text"===o?s.childNodes[0].textContent:s.innerHTML}};return r});
define("routes/router",["jquery","underscore","backbone","models/error/user","views/error/user"],function(e,a,i,p,s){"use strict";var t=i.Router.extend({app:null,pages:{},initialize:function(e){this.app=e.app,this.pages=this.app.config.pages,i.history.start()},page:function(i){var p,s=this;try{if(i||(i=this.pages.home),p=this.pages.pages[i],void 0===p)throw"missing config"}catch(t){this.page("404")}var n=e.Deferred();s.app.fetch("views/clear").done(function(e){e.render(),n.resolve()}),n.done(function(){a.each(p,function(e){var p,t;if(a.has(e,"view"))p=e.view,t={};else if(a.has(e,"partial"))p="views/partial",e.partial.page=s.app.config.pages.pathBase+e.partial.page,t=e.partial;else{if(!a.has(e,"page"))throw"unsupported page type: "+i;p="views/page",e.page=s.app.config.pages.pathBase+e.page,t=e.page}s.app.fetch(p,t).done(function(e){e.render()})})})},article:function(i){var p=this,s=[];a.each(["views/issue","views/map","views/menu"],function(a){var i=e.Deferred();s.push(i),p.app.fetch(a).done(function(e){e.render(),i.resolve()})}),e.when.apply({},s).done(function(){p.app.fetch("models/issue").done(function(e){e.show(i)})}).fail(function(){console.log("Failed to display article: "+i)})}});return t});
define("models/app",["jquery","underscore","backbone","models/error/user","views/error/user","routes/router","views/app"],function(e,n,i,t,s,o,r){"use strict";var a=i.Model.extend({config:{},router:null,singletons:{},initialize:function(i){var t=this;t.config=i.config;var s=t._initSingletons();n.extend(t,{classname:"models/app"}),e.when.apply(e,s).done(function(){t.router=new o({app:t,routes:t.config.pages.routes})});new r({model:t})},_initSingletons:function(){var i=this;if(n.has(this.config,"persistance")){n.pluck(n.where(this.config.persistance,{persist:!0,singleton:!0}),"name").forEach(function(n){if(void 0!==i.singletons[n])throw new s({model:new t({msg:"Cannot instantiate from '"+n+"' as non-singleton"})}),"Multiple instantiation in app.initialize";i.singletons[n]=e.Deferred()});var o=[];return n.each(n.keys(i.singletons),function(e){if(!e.match(/^collection/)){var n=i.singletons[e];i._create(e,n),o.push(n.promise())}}),o}},_isSingleton:function(e){return n.has(this.config,"persistance")&&n.where(this.config.persistance,{name:e,persist:!0,singleton:!0}).length>0},_create:function(e,i,t){var s=this;require([e],function(o){var r,a={app:s,init:i};if(e.match(/^collection/))throw"Construct collection synchronously";var c=n.extend(a,t);r=new o(c),r=n.extend(r,{classname:e})})},fetch:function(n,i){var t;return this._isSingleton(n)?t=this.singletons[n]:(t=e.Deferred(),this._create(n,t,i)),t.promise()}});return a});
define("models/article",["jquery","underscore","backbone","views/article","mixins/fetchxml","views/article/menu"],function(e,i,t,n,l,r){"use strict";var a=t.Model.extend({app:null,init:null,initialize:function(i){var t=this;t.app=i.app,t.init=i.init;var n=this.fetchXML(t,t.get("path"));e.when(n).done(function(e){t.set("xml",e),t.set("init",!0),t.trigger("init"),t.init.resolve(t)}).fail(function(e,i,n){console.log("Failed to retrieve article ("+t.get("id")+"), : "+n),t.init.fail()})},defaults:{xml:null,init:!1,marker:null},select:function(){new n({model:this});this.trigger("active")},unselect:function(){this.trigger("inactive")},menulabel:function(e){var i=new r({model:this});return i.render(e)}});return i.extend(a.prototype,l),a});
define("models/issue",["jquery","underscore","backbone","models/article","collections/articles"],function(e,i,t,n,a){"use strict";var l=t.Model.extend({app:null,init:null,initialize:function(t){var l=this;l.app=t.app,l.init=t.init;var c=l.app.config.articles.pathBase,o=l.app.config.articles.files,r=l.app.singletons["collections/articles"],s=new a(null,{model:n,app:l.app,init:r});l.set("collection",s);var p=[],f=i.map(i.range(o.length),function(){return void 0});i.each(o,function(i,t){var n=e.Deferred();p.push(n);var a={articleid:t,articledir:c,path:c+i};l.app.fetch("models/article",a).done(function(e){f[t]=e,n.resolve(e)}).fail(function(){n.fail()})}),e.when.apply({},p).done(function(){s.add(f),s.trigger("complete"),i.each(p,function(e){e.done(function(e){s.add(e)})}),l.init.resolve(l)}).fail(function(){l.init.fail()})},defaults:{articlefile:"",articledir:"",collection:[]},show:function(e){var t=this,n=t.get("collection");if(n.length>e){if(!n.at(e).get("active")){i.forEach(n.where({active:!0}),function(e){e.unselect()});var a=n.at(e);a.init.done(function(){a.select(),t.app.fetch("models/map").done(function(i){i.show(e)})})}}else this.app.router.navigate("page/404",{trigger:!0})}});return l});
define("models/map",["jquery","underscore","backbone","collections/markers","models/marker","views/marker","views/article/geojson","mixins/xml2html"],function(e,n,i,o,t,l,a,c,r){"use strict";var s=i.Model.extend({app:null,init:null,initialize:function(n){var i=this;i.app=n.app,i.init=n.init;var o,t=i.app.fetch("models/issue"),l=e.Deferred();i.app.fetch("models/issue").done(function(e){i.app.fetch("collections/articles").done(function(e){o=e,l.resolve()})});var a=e.getJSON(i.app.config.map.config,function(e){i.set("mapconfig",e)}).fail(function(e,n,i){console.log("Failed to load map config file: "+i)});e.when(t,l,a).done(function(){i._makeCollection(o,{success:function(){i.init.resolve(i)},fail:function(){i.init.fail()}})}).fail(function(e,n,i){console.log("Failed to init MapModel: "+i),$def.fail()})},defaults:{init:!1,mapconfig:{},geojson:{}},show:function(e){var n=this.get("collection");n.at(e).select()},_makeCollection:function(n,i){var c=this,r=c.app.singletons["collections/articles"],s=new o(null,{model:t,app:c.app,init:r});c.set("collection",s);var f=[];n.forEach(function(n){var i=(n.get("articleid"),e.Deferred());f.push(i),n.init.done(function(){var e;try{e=new t({articleid:n.get("articleid"),json:new a({model:n}).render()})}catch(o){return new UserErrorView({model:new UserErrorModel({msg:o.toString()})}),void i.resolve()}e.on("select",function(e){c.app.router.navigate("article/"+e,{trigger:!0})});var r=new l({model:e});e.set("view",r),s.add(e),i.resolve()})}),e.when.apply({},f).done(function(){s.trigger("complete"),i.success()}).fail(function(){i.fail()})}});return n.extend(s.prototype,c),s});
define("models/marker",["jquery","underscore","backbone"],function(e,t,r){"use strict";var i=r.Model.extend({defaults:{articleid:0,view:null,json:{},selected:!1},select:function(){this.trigger("select",this.get("articleid"))}});return i});
define("models/menu",["jquery","underscore","backbone"],function(e,i,n){"use strict";var t=n.Model.extend({app:null,init:null,initialize:function(e){var i=this;i.app=e.app,i.init=e.init,i.init.resolve(i)},defaults:{items:[]}});return t});
define("views/app",["jquery","underscore","backbone"],function(e,n,i){"use strict";var o=i.View.extend({el:"body",initialize:function(){e(window).resize(function(){document.location.reload()})}});return o});
define("views/article",["jquery","underscore","backbone","mixins/domwatcher","mixins/xml2html","text!xsl/article.xsl","text!partials/popover.html","text!partials/popover-content.html","slidesjs"],function(e,i,t,s,o,l,n,r){"use strict";var a=t.View.extend({el:"#article",initialize:function(e){var i=this;i.app=e.model.app,i.listenToOnce(i.model,"active",i.render),i.listenToOnce(i.model,"inactive",i.remove)},render:function(i){var t=this,s=this.xml2html(this.model.get("xml"),l,{"article-dir":t.app.config.articles.pathBase});t.$el.append(s),0===e("img.slidesjs-slide").length?(e("#footer").remove(),e("article").removeClass("before-footer").addClass("no-footer")):t.postprocess()},postprocess:function(){var t=this,s=i.template(r);e("img.slidesjs-slide").each(function(i,t){var o=t.getAttribute("id"),l=e(".popover."+o).remove(),r=l.find(".head").text(),a=s({desc:l.find(".desc").text(),attr:l.find(".attr").text()});e(t).popover({container:"body",html:!0,content:a,title:r,template:n,trigger:"hover",placement:"left"})});var o=[];return t.$el.find("img.slidesjs-slide").each(function(i,t){var s=e.Deferred();e(t).load(function(){e(t).removeClass("remove"),s.resolve()}),e(t).error(function(){window.setTimeout(function(){s.reject()},500)}),o.push(s)}),e.when.apply({},o).always(function(){e("img.slidesjs-slide.remove").remove(),e("#slides").slidesjs({navigation:{active:e("img.slidesjs-slide").length>1,effect:"fade"},pagination:{active:e("img.slidesjs-slide").length>1,effect:"fade"},effect:{fade:{speed:100,crossfade:!0}},callback:{loaded:function(i){var t=e(".slidesjs-control").children(":eq("+(i-1)+")");t.css({visibility:"hidden"}),t.css({height:e(".slidesjs-container").height(),width:"auto"});var s=(e(".slidesjs-container").width()-t.width())/2;t.css({left:s}),t.css({visibility:"visible"})},start:function(i){e(".slidesjs-control").children().css({visibility:"hidden"})},complete:function(i){var t=i-1,s=e(".slidesjs-control").children(":eq("+t+")");s.css({height:e(".slidesjs-container").height(),width:"auto",position:"relative"}),s.css({visibility:"visible"})}}})}),t}});return i.extend(a.prototype,s),i.extend(a.prototype,o),a});
define("views/clear",["jquery","underscore","backbone"],function(e,i,n,t){"use strict";var r=n.View.extend({el:"body",app:null,init:null,initialize:function(e){var i=this;i.app=e.app,i.init=e.init,i.init.resolve(i)},render:function(){e("body").empty()}});return r});
define("views/issue",["jquery","underscore","backbone","text!partials/issue.html"],function(e,i,t,n){"use strict";var s=t.View.extend({el:"#issue",template:i.template(n),app:null,init:null,initialize:function(e){var i=this;i.app=e.app,i.init=e.init,this.app.fetch("models/issue").done(function(e){i.model=e,i.init.resolve(i)})},render:function(){this.$el.remove(),e("body").append(n)}});return s});
define("views/leftpage",["jquery","underscore","backbone","text!partials/page.html"],function(e,t,n,a){"use strict";var r=n.View.extend({el:"#left-content",template:t.template(a),render:function(e){this.$el.empty().append(this.template(e))}});return r});
define("views/map",["jquery","underscore","backbone","leaflet","text!partials/map.html"],function(e,n,t,i,o){"use strict";var a=t.View.extend({id:"map",tagName:"div",app:null,init:null,initialize:function(e){var n=this;n.app=e.app,n.init=e.init,this.app.fetch("models/map").then(function(e){n.model=e,n.listenToOnce(e,"change",n.render),n.init.resolve(n)}).fail(function(e){console.log("Failed to init map view.")})},render:function(){var n=this;if(!(e("#"+this.id).children().length>0)){e("body").append(o);var t=this.model.get("collection"),a=this.model.get("mapconfig"),r=new i.Map(a.id,a.map),p=new i.TileLayer(a.tileLayer.url,a.tileLayer.opts);r.setView(new i.LatLng(a.view.lat,a.view.lng),a.view.zoom),r.addLayer(p);var c=i.control.scale(a.scale);c.addTo(r);var l={},u=function(e){return e.lat.toString()+e.lng.toString()};r.invalidateSize();var s=function(){t.forEach(function(e){var n=e.get("json"),t=e.get("view");i.geoJson(n,{onEachFeature:function(n,o){var r=i.popup(a.features.popup);r.setContent(t.el),o.bindPopup(r),o.removeEventListener("click"),o.on("click",function(){e.select()}),o.on("mouseover",function(){l[u(o.getLatLng())]||o.openPopup()}),e.on("select",function(e){l[u(o.getLatLng())]||o.openPopup()}),l[u(o.getLatLng())]=!1},pointToLayer:function(e,n){return i.marker(n,{icon:i.icon(a.features.icon),clickable:!!e.properties.text,title:e.properties.markername||"",opacity:a.features.opacity,riseOnHover:a.features.riseOnHover})}}).addTo(r)}),r.on("popupopen",function(e){l[u(e.popup.getLatLng())]=-1!=navigator.userAgent.indexOf("Firefox")?!0:!0}),r.on("popupclose",function(e){l[u(e.popup.getLatLng())]=-1!=navigator.userAgent.indexOf("Firefox")?!1:!1})};window.setTimeout(s,n.app.config.map.markerDelay)}}});return a});
define("views/marker",["jquery","underscore","backbone","text!partials/marker.html"],function(e,t,i,r){"use strict";var a=i.View.extend({template:t.template(r),el:"",initialize:function(){this.$el.html(this.template({articleid:this.model.attributes.articleid,geojson:this.model.attributes.json}))}});return a});
define("views/menu",["jquery","underscore","backbone","text!partials/menu.html","mixins/domwatcher"],function(e,n,t,i,o){"use strict";var r=t.View.extend({template:n.template(i),el:"#menu",app:null,init:null,initialize:function(e){var n=this;n.app=e.app,n.init=e.init,n.app.fetch("models/menu",{items:n.app.config.menu}).done(function(e){n.model=e,n.init.resolve(n)})},render:function(){var t=this,i=this.model.get("items"),o=[],r={},l={};n.each(i,function(n){if(r[n.partial]="","menu"===n.type){var i=e.Deferred();t.app.fetch(n.collection).done(function(e){l[n.collection]=e,i.resolve()}),o.push(i.promise())}}),n.each(n.keys(r),function(t){var i=e.Deferred();require(["text!"+t],function(e){r[t]=n.template(e),i.resolve()}),o.push(i.promise())});var a="";e.when.apply(e,o).done(function(){n.forEach(i,function(e,n){var t=e.partial;if("page"===e.type||"sep"===e.type)a+=r[t](e);else if("menu"===e.type){var i="";l[e.collection].models.forEach(function(n,t){var o=e.item.href.replace(":i",t);i+=n.menulabel({href:"#"+o})}),a+=r[t]({label:e.label,items:i})}})}).done(function(){t.$el.empty().append(t.template({content:a}))}).fail(function(){new UserErrorView({model:new UserErrorModel({msg:"Failed to build menu."})})})}});return n.extend(r.prototype,o),r});
define("views/page",["jquery","underscore","backbone","mixins/domwatcher","text!partials/page.html"],function(e,i,t,n,r){"use strict";var a=t.View.extend({el:"body",app:null,init:null,initialize:function(e){var i=this;i.app=e.app,i.init=e.init,i.init.resolve(i)},render:function(){var i=this,t=e.Deferred();t.then(function(){e(i.el).append(r)}),this.watchDOM(1e3,i.el,t)}});return i.extend(a.prototype,n),a});
define("views/partial",["jquery","underscore","backbone","mixins/domwatcher"],function(e,i,n,t){"use strict";var r=n.View.extend({el:"",app:null,init:null,page:"",initialize:function(e){var i=this;i.app=e.app,i.init=e.init,i.el=e.el,require(["text!"+e.page],function(e){i.page=e,i.init.resolve(i)})},render:function(){var i=this,n=e.Deferred();n.then(function(){e(i.el).append(i.page)}),this.watchDOM(1e3,i.el,n)}});return i.extend(r.prototype,t),r});
define("views/rightpage",["jquery","underscore","backbone","text!partials/page.html"],function(e,t,n,r){"use strict";var i=n.View.extend({el:"#right-content",template:t.template(r),render:function(e){this.$el.empty().append(this.template(e))}});return i});
define("models/error/user",["backbone"],function(e){"use strict";var r=e.Model.extend({defaults:{msg:""}});return r});
define("views/article/body",["jquery","underscore","backbone","views/article/section","text!xsl/body.xsl"],function(e,t,s,i,r){"use strict";var n=i.extend({el:"#body",$el:e("#body"),xsl:r,name:"body",render:function(){var e=this.xml2html(this.model.get("xml"),this.xsl,this.params);return this.$el.append(e),this}});return n});
define("views/article/footer",["jquery","underscore","backbone","text!xsl/footer.xsl","text!partials/popover.html","text!partials/popover-content.html","mixins/xml2html","mixins/domwatcher","slidesjs"],function(e,t,o,i,r,n,a,p){"use strict";var s=o.View.extend({id:"footer",tagName:"div",xsl:i,name:"footer",app:null,initialize:function(e){var t=this;t.app=e.app}});return t.extend(s.prototype,a),t.extend(s.prototype,p),s});
define("views/article/geojson",["jquery","underscore","backbone","mixins/xml2html","text!xsl/geojson.xsl"],function(e,t,r,o,n){"use strict";var i=r.View.extend({render:function(e){var t=this,r=(new DOMParser).parseFromString(n,"text/xml");if("resolved"!==this.model.init.state())throw"Uninitialized article in GeoJsonView";var o;try{o=JSON.parse(t.xml2html(t.model.get("xml"),r,{},"text"))}catch(i){throw console.log("Failed to parse to json: "+i.toString()),"Failed to parse to json: "+i.toString()}return o}});return t.extend(i.prototype,o),i});
define("views/article/header",["jquery","underscore","backbone","views/article/section","text!xsl/header.xsl"],function(e,r,a,t,n){"use strict";var s=t.extend({el:"#header",$el:e("#header"),xsl:n,name:"header"});return s});
define("views/article/menu",["jquery","underscore","backbone","mixins/xml2html","text!xsl/article-menu.xsl"],function(e,t,r,i,n){"use strict";var l=r.View.extend({render:function(e){var t=this,r=(new DOMParser).parseFromString(n,"text/xml");if("resolved"!==this.model.init.state())throw"Uninitialized article in ArticleMenuView";var i=t.xml2html(t.model.get("xml"),r,e);return i}});return t.extend(l.prototype,i),l});
define("views/article/section",["jquery","underscore","backbone","mixins/xml2html"],function(e,t,i,n){"use strict";var r=i.View.extend({render:function(){var e=this.xml2html(this.model.get("xml"),this.xsl,this.params);return this.$el.append(e),this}});return t.extend(r.prototype,n),r});
define("views/error/user",["jquery","backbone","text!partials/error/user.html"],function(e,t,r){"use strict";var i=t.View.extend({template:_.template(r),el:e("#errorDialog"),initialize:function(){this.render()},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.modal({keyboard:!0,show:!0}),this}});return i});
require.config({baseUrl:"app/js",paths:{text:"//cdnjs.cloudflare.com/ajax/libs/require-text/2.0.12/text.min",jquery:"//code.jquery.com/jquery-2.1.4.min",bootstrap:"//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min",backbone:"//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min",underscore:"//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min",leaflet:"//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet",slidesjs:"//cdnjs.cloudflare.com/ajax/libs/slidesjs/3.0/jquery.slides.min",partials:"../partials",xsl:"../script/xsl",pages:"../pages"},shim:{bootstrap:{deps:["jquery"]},backbone:{deps:["jquery","underscore"],exports:"Backbone"},underscore:{exports:"_"},text:{deps:[]},slidesjs:{deps:["jquery"]}}}),require(["jquery","models/error/user","views/error/user","models/app","bootstrap"],function(e,s,o,r){"use strict";var a=e("#main").attr("data-config");a?e.getJSON(a,function(e){new r({config:e})}).fail(function(e,r,n){new o({model:new s({msg:"Failed to load site config file '"+a+"' "+n})})}):new o({model:new s({msg:"No configuration filename specified in home page."})})});